<!doctype html><html lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Admin Upload — Hugo</title><link rel="stylesheet" href="styles.css"><style>.admin{max-width:900px;margin:20px auto;padding:16px;border:1px solid #222;border-radius:12px;background:#111}.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.drop{border:2px dashed #444;border-radius:12px;padding:20px;text-align:center;color:#9aa;margin-top:12px}.drop.dragover{border-color:#888;background:#0f0f0f}.files{margin-top:10px}.thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}.thumb{border:1px solid #222;border-radius:12px;padding:8px;background:#0f0f0f}.thumb img,.thumb video{width:100%;height:120px;object-fit:cover;border-radius:6px;background:#000}.thumb .name{font-size:12px;color:#9aa;margin-top:6px;word-break:break-all}
.thumb .info{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
.thumb .resolution{font-size:11px;color:#666}
.thumb .delete{background:#d32f2f;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;transition:background .2s}
.thumb .delete:hover{background:#b71c1c}</style></head><body><header><a href="index.html">← Site</a><h1>Admin Upload</h1></header><main class="admin"><div class="row"><label for="project">Projet</label><select id="project"></select><button id="refresh">Rafraîchir</button></div><div class="drop" id="drop">Glissez-déposez des fichiers ici ou <input type="file" id="file" multiple></div><div class="row"><button id="upload">Téléverser</button><button id="reindex">Reindexer</button><span id="status"></span></div><div class="files" id="files"></div></main><script>async function fetchJSON(u, opt){const r=await fetch(u,opt); if(!r.ok) throw new Error(await r.text()); return r.json();}const projectSel=document.getElementById('project');const statusEl=document.getElementById('status');const filesEl=document.getElementById('files');const drop=document.getElementById('drop');const fileInput=document.getElementById('file');const uploadBtn=document.getElementById('upload');const reindexBtn=document.getElementById('reindex');const refreshBtn=document.getElementById('refresh');let queue=[];function setStatus(t){statusEl.textContent=t||'';}async function loadProjects(){const j=await fetchJSON('/api/projects');projectSel.innerHTML=j.projects.map(p=>`<option value="${p.id}">${p.title}</option>`).join('');await loadFiles();}function renderThumbs(slug, files){if(!files||!files.length){filesEl.innerHTML='<p style="color:#9aa">Aucun fichier.</p>';return;}let html='<div class="thumbs">';for(const f of files){const url=`/media/${encodeURIComponent(slug)}/${encodeURIComponent(f)}`;const lower=f.toLowerCase();const vid=/\.(mp4|webm|mov)$/.test(lower);const img=/\.(jpg|jpeg|png|webp)$/.test(lower);const canImg=img; if(canImg){html+=`<div class="thumb"><a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="${f}" onload="this.parentElement.parentElement.querySelector('.resolution').textContent=this.naturalWidth+'×'+this.naturalHeight"></a><div class="name">${f}</div><div class="info"><span class="resolution">Loading...</span><button class="delete" onclick="deleteFile('${slug}','${f}')">Delete</button></div></div>`;} else if(vid){html+=`<div class="thumb"><a href="${url}" target="_blank" rel="noopener"><video src="${url}" muted></video></a><div class="name">${f}</div><div class="info"><span class="resolution">Video</span><button class="delete" onclick="deleteFile('${slug}','${f}')">Delete</button></div></div>`;} else {html+=`<div class="thumb"><a href="${url}" target="_blank" rel="noopener">${f}</a><div class="info"><span class="resolution">File</span><button class="delete" onclick="deleteFile('${slug}','${f}')">Delete</button></div></div>`;}}html+='</div>';filesEl.innerHTML=html;}async function loadFiles(){const slug=projectSel.value;if(!slug){filesEl.textContent='';return;}const j=await fetchJSON('/api/media/'+encodeURIComponent(slug));renderThumbs(slug,j.files);}function onFiles(files){queue=[...queue,...files];setStatus(`${queue.length} fichier(s) en attente`);}drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('dragover');});drop.addEventListener('dragleave',()=>drop.classList.remove('dragover'));drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('dragover');onFiles(e.dataTransfer.files);});fileInput.addEventListener('change',e=>onFiles(e.target.files));uploadBtn.addEventListener('click',async()=>{if(queue.length===0){setStatus('Aucun fichier');return;}const slug=projectSel.value;const fd=new FormData();queue.forEach(f=>fd.append('files',f,f.name));setStatus('Téléversement en cours...');try{const j=await fetchJSON('/api/upload/'+encodeURIComponent(slug),{method:'POST',body:fd});setStatus(`OK: ${j.files.length} fichier(s)`);queue=[];await loadFiles();}catch(e){setStatus('Erreur: '+e.message);}});reindexBtn.addEventListener('click',async()=>{setStatus('Reindexage...');try{await fetchJSON('/api/reindex',{method:'POST'});setStatus('Index régénéré');await loadFiles();}catch(e){setStatus('Erreur: '+e.message);}});refreshBtn.addEventListener('click',loadFiles);projectSel.addEventListener('change',loadFiles);async function deleteFile(slug,filename){if(!confirm(`Supprimer ${filename}?`))return;setStatus('Suppression...');try{await fetchJSON('/api/delete/'+encodeURIComponent(slug)+'/'+encodeURIComponent(filename),{method:'DELETE'});setStatus('Fichier supprimé');await loadFiles();}catch(e){setStatus('Erreur: '+e.message);}}loadProjects();</script></body></html>
